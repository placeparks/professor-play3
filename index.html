<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCGPlaytest | Custom Card Printing USA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#151e2e',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        .hero-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .dark .hero-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .card-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Stepper Specific Styles */
        .step-active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }
        .dark .step-active {
            color: #60a5fa;
            border-bottom: 2px solid #60a5fa;
        }
        .step-inactive {
            color: #64748b;
        }
        .dark .step-inactive {
            color: #94a3b8;
        }
        
        /* Light Mode Canvas */
        .canvas-area {
            background-image: 
                linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* Dark Mode Canvas */
        .dark .canvas-area {
            background-image: 
                linear-gradient(45deg, #1e293b 25%, transparent 25%), 
                linear-gradient(-45deg, #1e293b 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #1e293b 75%), 
                linear-gradient(-45deg, transparent 75%, #1e293b 75%);
            background-color: #0f172a;
        }

        /* --- LANDING PAGE ANIMATION --- */
        .bg-card-floater {
            position: absolute;
            width: 100px;
            height: 140px; /* Standard Aspect Ratio */
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            /* Transform set by JS for parallax */
            transform-origin: center center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            pointer-events: auto;
            z-index: 0;
        }

        /* Floating Animation (Bobbing) - Applied via margin to play nice with transform parallax */
        @keyframes float-y {
            0%, 100% { margin-top: 0px; }
            50% { margin-top: -20px; }
        }

        .bg-card-floater {
            animation: float-y 6s ease-in-out infinite;
        }

        .bg-card-floater:hover {
            background: rgba(59, 130, 246, 0.15); /* Blue-500 tint */
            border-color: rgba(59, 130, 246, 0.4);
            cursor: default;
            animation-play-state: paused;
        }

        .dark .bg-card-floater {
            background: rgba(30, 41, 59, 0.3); /* Slate-800 tint */
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        
        .dark .bg-card-floater:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .drag-active {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
        .dark .drag-active {
            border-color: #60a5fa;
            background-color: #1e3a8a;
        }

        /* Scrollbar styling for grid */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animation Classes */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-modal {
            animation: fadeIn 0.2s ease-out forwards;
        }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            width: 100%;
            background: transparent; 
            margin: 8px 0;
        }
        input[type=range]:focus {
            outline: none;
        }
        /* Track */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #334155;
            border: 1px solid #475569;
        }
        /* Thumb */
        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -7px; /* centers thumb on track */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        .dark input[type=range]::-webkit-slider-thumb {
            border: 2px solid #cbd5e1;
        }
        input[type=range]:focus::-webkit-slider-thumb {
            background: #1d4ed8;
            transform: scale(1.1);
        }
        /* Firefox Styles */
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
        }
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border: 2px solid white;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Flip Card Styles */
        .flip-card {
            perspective: 1000px;
        }
        .flip-card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            width: 100%;
            height: 100%;
            position: relative;
        }
        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .flip-card-back {
            transform: rotateY(180deg);
            background-color: #f8fafc; /* Fallback color */
        }
        .dark .flip-card-back {
            background-color: #1e293b;
        }
    </style>
</head>
<body class="text-slate-800 bg-white dark:bg-slate-950 dark:text-slate-100 min-h-screen flex flex-col transition-colors duration-300">

    <!-- Navigation -->
    <nav class="border-b border-slate-200 dark:border-slate-800 sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm z-40 transition-colors duration-300">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2 cursor-pointer" onclick="showLanding()">
                <!-- Placeholder for logo -->
                <div class="h-10 w-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                    <i data-lucide="layers" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-xl tracking-tight text-slate-900 dark:text-white">TCGPlaytest</span>
            </div>

            <!-- Main Nav Links (Hidden in Stepper Mode) -->
            <div id="main-nav-links" class="hidden md:flex items-center space-x-8 font-medium text-sm text-slate-600 dark:text-slate-300">
                <a href="#" onclick="showHowItWorks()" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">How it Works</a>
                <a href="#" onclick="showPricing()" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Pricing</a>
                <a href="#" onclick="showWhyUs()" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Why Us</a>
            </div>

            <div class="flex items-center gap-4">
                <!-- Dark Mode Toggle -->
                <button onclick="toggleTheme()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 transition-colors" title="Toggle Dark Mode">
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                </button>

                 <!-- Exit Button (Visible only in Stepper Mode) -->
                <button id="exit-btn" onclick="showLanding()" class="hidden text-slate-500 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400 text-sm font-medium items-center gap-1">
                    <i data-lucide="x" class="w-4 h-4"></i> Exit
                </button>

                <button id="start-btn" onclick="startDesign()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-md font-semibold text-sm transition-colors shadow-sm">
                    Start Your Design
                </button>
            </div>
            
            <!-- Mobile Menu Button -->
            <button class="md:hidden text-slate-600 dark:text-slate-300 ml-4">
                <i data-lucide="menu"></i>
            </button>
        </div>
    </nav>

    <!-- VIEWS CONTAINER -->
    <main class="flex-grow relative">
        
        <!-- VIEW 1: LANDING PAGE -->
        <div id="landing-view">
            <!-- Hero Section -->
            <header id="landing-hero" class="hero-bg py-16 md:py-24 border-b border-slate-200 dark:border-slate-800 transition-colors duration-300 relative overflow-hidden" onmousemove="updateParallax(event)">
                
                <!-- Animated Background Container -->
                <div id="hero-bg-anim" class="absolute inset-0 w-full h-full pointer-events-none z-0 overflow-hidden">
                    <!-- JS will inject cards here -->
                </div>

                <div class="container mx-auto px-4 grid md:grid-cols-2 gap-12 items-center relative z-10">
                    <div class="space-y-6">
                        <div class="inline-flex items-center px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-bold uppercase tracking-wide">
                            No Minimum Order
                        </div>
                        <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 dark:text-white leading-tight">
                            Professional Custom Cards. <br>
                            <span class="text-blue-600 dark:text-blue-400">Made in the USA.</span>
                        </h1>
                        <p class="text-lg text-slate-600 dark:text-slate-300 max-w-lg">
                            Design and print your custom card games and TCG prototypes with TCGPlaytest. 
                            Fast shipping, no tariffs, and premium quality S33 cardstock.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 pt-4">
                            <button onclick="startDesign()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-bold text-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                                Start Design <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-6 text-sm text-slate-500 dark:text-slate-400 pt-4">
                            <div class="flex items-center gap-1">
                                <i data-lucide="truck" class="w-4 h-4 text-green-600 dark:text-green-400"></i> 3-5 Day US Shipping
                            </div>
                            <div class="flex items-center gap-1">
                                <i data-lucide="shield-check" class="w-4 h-4 text-green-600 dark:text-green-400"></i> Tariff Free
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <!-- Abstract Card visual using CSS/HTML -->
                        <div class="relative w-full max-w-md mx-auto aspect-[4/3]">
                            <div class="absolute top-0 right-0 w-48 h-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 transform rotate-6 z-10 flex flex-col items-center justify-center p-4 transition-colors">
                                <div class="w-full h-full border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-800/50 flex items-center justify-center">
                                    <span class="text-slate-400 dark:text-slate-500 font-semibold">Card Back</span>
                                </div>
                            </div>
                            <div class="absolute top-8 right-12 w-52 h-60 rounded-xl shadow-xl transform -rotate-3 z-20 overflow-hidden">
                                <img src="/public/card.jpg" alt="TCGPlaytest Card" class="w-full h-full object-cover rounded-xl">
                            </div>
                            <div class="absolute -bottom-4 -left-4 w-full h-full bg-blue-100 dark:bg-blue-900/20 rounded-full filter blur-3xl opacity-30 -z-10"></div>
                        </div>
                    </div>
                </div>
            </header>
        </div>

        <!-- VIEW 1.5: HOW IT WORKS PAGE -->
        <div id="how-it-works-view" class="hidden bg-white dark:bg-slate-950">
            <div class="container mx-auto px-4 py-16 max-w-5xl">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 dark:text-white mb-4">From Digital to Tabletop in Days</h2>
                    <p class="text-lg text-slate-600 dark:text-slate-300 max-w-2xl mx-auto">Create professional quality trading card prototypes without the hassle. Here is how our simple process works.</p>
                </div>

                <div class="grid md:grid-cols-3 gap-12 mb-16">
                    <!-- Step 1 -->
                    <div class="text-center space-y-4">
                        <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-6 transform rotate-3 hover:rotate-6 transition-transform">
                            <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">1. Upload Your Art</h3>
                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed">Drag and drop your card images or import a deck list directly. Our tool automatically handles basic formatting.</p>
                    </div>
                    <!-- Step 2 -->
                    <div class="text-center space-y-4">
                        <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-6 transform -rotate-2 hover:-rotate-6 transition-transform">
                            <i data-lucide="edit-3" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">2. Customize & Prep</h3>
                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed">Set card backs, adjust bleed/trim settings, and use our built-in editor for last-minute tweaks.</p>
                    </div>
                    <!-- Step 3 -->
                    <div class="text-center space-y-4">
                        <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-6 transform rotate-1 hover:rotate-3 transition-transform">
                            <i data-lucide="package-check" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white">3. Order & Ship</h3>
                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed">Review your digital proof grid. Once approved, we print on premium S33 cardstock.</p>
                    </div>
                </div>

                <!-- Shipping Banner -->
                <div class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-8 md:p-12 text-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-32 bg-blue-100 dark:bg-blue-900/20 rounded-full filter blur-3xl opacity-20 -mr-16 -mt-16"></div>
                    <div class="relative z-10">
                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full text-sm font-bold uppercase tracking-wide mb-6">
                            <i data-lucide="zap" class="w-4 h-4"></i> Lightning Fast Fulfillment
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Don't wait weeks for your prototype.</h3>
                        <p class="text-lg text-slate-600 dark:text-slate-300 max-w-3xl mx-auto mb-8">
                            We know you need to playtest <em>now</em>. That's why we ship all orders <strong>within 1 business day</strong> of receiving payment. Expect your cards at your door within <strong>3-5 business days</strong>.
                        </p>
                        <button onclick="startDesign()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition-transform hover:scale-105 inline-flex items-center gap-2">
                            Start Your Design Now <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 1.6: PRICING PAGE -->
        <div id="pricing-view" class="hidden bg-white dark:bg-slate-950">
            <div class="container mx-auto px-4 py-16 max-w-5xl">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 dark:text-white mb-4">Simple, Volume-Based Pricing</h2>
                    <p class="text-lg text-slate-600 dark:text-slate-300 max-w-2xl mx-auto">Premium S33 cardstock. No hidden fees. Automatic discounts as your deck size grows.</p>
                </div>

                <!-- Pricing Tiers -->
                <div class="grid md:grid-cols-3 gap-8 mb-16">
                    <!-- Tier 1 -->
                    <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-8 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-1 bg-slate-200 dark:bg-slate-700 group-hover:bg-blue-500 transition-colors"></div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Starter Deck</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Perfect for Commander decks or small prototypes.</p>
                        <div class="flex items-baseline mb-6">
                            <span class="text-4xl font-extrabold text-slate-900 dark:text-white">$0.35</span>
                            <span class="text-slate-500 dark:text-slate-400 ml-2">/ card</span>
                        </div>
                        <ul class="space-y-3 text-sm text-slate-600 dark:text-slate-300 mb-8">
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500 dark:text-green-400"></i> 1 – 144 cards</li>
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500 dark:text-green-400"></i> S33 Premium Stock</li>
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500 dark:text-green-400"></i> Full Color Print</li>
                        </ul>
                        <div class="w-full bg-slate-100 dark:bg-slate-800 h-2 rounded-full overflow-hidden">
                            <div class="bg-slate-300 dark:bg-slate-600 h-full w-1/3"></div>
                        </div>
                    </div>

                    <!-- Tier 2 (Best Value) -->
                    <div class="bg-white dark:bg-slate-900 border-2 border-blue-600 rounded-2xl p-8 shadow-xl relative overflow-hidden transform md:-translate-y-4">
                        <div class="absolute top-0 right-0 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">BEST VALUE</div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Playtest Set</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Ideal for cubes, battle boxes, or multiple decks.</p>
                        <div class="flex items-baseline mb-6">
                            <span class="text-4xl font-extrabold text-blue-600 dark:text-blue-400">$0.30</span>
                            <span class="text-slate-500 dark:text-slate-400 ml-2">/ card</span>
                        </div>
                        <ul class="space-y-3 text-sm text-slate-600 dark:text-slate-300 mb-8">
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-blue-500 dark:text-blue-400"></i> 145 – 500 cards</li>
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-blue-500 dark:text-blue-400"></i> S33 Premium Stock</li>
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-blue-500 dark:text-blue-400"></i> Fast Production</li>
                        </ul>
                        <div class="w-full bg-blue-100 dark:bg-blue-900/30 h-2 rounded-full overflow-hidden">
                            <div class="bg-blue-600 h-full w-2/3"></div>
                        </div>
                    </div>

                    <!-- Tier 3 -->
                    <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-8 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-1 bg-slate-200 dark:bg-slate-700 group-hover:bg-green-500 transition-colors"></div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Bulk Order</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">For designers, clubs, and large collections.</p>
                        <div class="flex items-baseline mb-6">
                            <span class="text-4xl font-extrabold text-slate-900 dark:text-white">$0.26</span>
                            <span class="text-slate-500 dark:text-slate-400 ml-2">/ card</span>
                        </div>
                        <ul class="space-y-3 text-sm text-slate-600 dark:text-slate-300 mb-8">
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500 dark:text-green-400"></i> 500+ cards</li>
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500 dark:text-green-400"></i> Lowest Price Rate</li>
                            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-green-500 dark:text-green-400"></i> Priority Support</li>
                        </ul>
                        <div class="w-full bg-slate-100 dark:bg-slate-800 h-2 rounded-full overflow-hidden">
                            <div class="bg-green-500 h-full w-full"></div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Info -->
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-slate-50 dark:bg-slate-900 p-6 rounded-xl flex items-start gap-4 border border-slate-100 dark:border-slate-800">
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-full shadow-sm text-blue-600 dark:text-blue-400">
                            <i data-lucide="truck" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-900 dark:text-white text-lg">Domestic Shipping (USA)</h4>
                            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 mb-2">Flat rate for all deck sizes.</p>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white">$6.95</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-900 p-6 rounded-xl flex items-start gap-4 border border-slate-100 dark:border-slate-800">
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-full shadow-sm text-blue-600 dark:text-blue-400">
                            <i data-lucide="globe" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-900 dark:text-white text-lg">International Shipping</h4>
                            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 mb-2">Flat rate worldwide.</p>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white">$24.95</p>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-12">
                    <button onclick="startDesign()" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-lg font-bold text-lg shadow-lg transition-all inline-flex items-center gap-2">
                        Start Your Order <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 1.7: WHY US PAGE -->
        <div id="why-us-view" class="hidden bg-white dark:bg-slate-950">
            <div class="container mx-auto px-4 py-16 max-w-5xl">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 dark:text-white mb-4">Built for the Discerning Player</h2>
                    <p class="text-lg text-slate-600 dark:text-slate-300 max-w-2xl mx-auto">We combine industrial-grade technology with TCG-specific materials to create prototypes that look and feel real.</p>
                </div>

                <div class="space-y-16">
                    <!-- Feature 1: Color Accuracy -->
                    <div class="flex flex-col md:flex-row items-center gap-12">
                        <div class="w-full md:w-1/2 bg-slate-100 dark:bg-slate-900 rounded-2xl p-8 min-h-[300px] flex items-center justify-center relative overflow-hidden group">
                            <!-- Abstract representation of print head/color -->
                            <div class="absolute inset-0 bg-gradient-to-br from-pink-500/10 via-purple-500/10 to-cyan-500/10"></div>
                            <div class="relative z-10 flex gap-4">
                                <div class="w-16 h-32 bg-cyan-500 rounded-lg shadow-xl transform translate-y-4 opacity-90"></div>
                                <div class="w-16 h-32 bg-magenta-500 rounded-lg shadow-xl transform -translate-y-4 opacity-90" style="background-color: #ec4899;"></div>
                                <div class="w-16 h-32 bg-yellow-400 rounded-lg shadow-xl transform translate-y-2 opacity-90"></div>
                                <div class="w-16 h-32 bg-slate-900 dark:bg-slate-700 rounded-lg shadow-xl transform -translate-y-2 opacity-90"></div>
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 space-y-4">
                            <div class="inline-flex items-center gap-2 px-3 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-full text-xs font-bold uppercase tracking-wide">
                                <i data-lucide="aperture" class="w-3 h-3"></i> Print Technology
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">100% Perfect Color Accuracy</h3>
                            <p class="text-slate-600 dark:text-slate-300 leading-relaxed">
                                We utilize a state-of-the-art, 6-color print engine designed for the highest end of digital production. 
                            </p>

                            <ul class="space-y-3 text-sm text-slate-600 dark:text-slate-300">
                                <li class="flex items-start gap-3">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-purple-600 dark:text-purple-400 shrink-0 mt-0.5"></i>
                                    <span><strong>Ultra HD Resolution:</strong> Rendering at 1200 x 1200 x 10-bit depth for butter-smooth gradients and sharp text.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-purple-600 dark:text-purple-400 shrink-0 mt-0.5"></i>
                                    <span><strong>Automated Color Quality:</strong> Inline spectrophotometers constantly monitor color consistency, ensuring your 100th card looks exactly like your first.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-purple-600 dark:text-purple-400 shrink-0 mt-0.5"></i>
                                    <span><strong>Wide Gamut:</strong> Capable of hitting vibrant hues that standard CMYK office printers simply can't reach.</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Feature 2: Material -->
                    <div class="flex flex-col md:flex-row-reverse items-center gap-12">
                        <div class="w-full md:w-1/2 bg-slate-100 dark:bg-slate-900 rounded-2xl p-8 min-h-[300px] flex items-center justify-center relative overflow-hidden">
                            <div class="w-48 h-64 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg shadow-2xl flex flex-col items-center justify-center transform rotate-3 transition-transform hover:rotate-0">
                                <div class="text-center space-y-2">
                                    <div class="text-xs font-bold text-slate-400 uppercase">Cross Section</div>
                                    <div class="h-32 w-2 bg-slate-800 mx-auto rounded-full"></div>
                                    <div class="text-xs font-bold text-slate-800 dark:text-slate-300">Black Core</div>
                                </div>
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 space-y-4">
                            <div class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-full text-xs font-bold uppercase tracking-wide">
                                <i data-lucide="layers" class="w-3 h-3"></i> Material Science
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">S33 Black Core Cardstock</h3>
                            <p class="text-slate-600 dark:text-slate-300 leading-relaxed">
                                Flimsy paper prototypes break immersion. Our cards are built on premium 330 GSM stock with a dedicated light-blocking black core layer.
                            </p>

                            <ul class="space-y-3 text-sm text-slate-600 dark:text-slate-300">
                                <li class="flex items-start gap-3">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5"></i>
                                    <span><strong>The "Snap" Test:</strong> Offers the authentic tactile resilience and auditory "snap" of a standard trading card.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5"></i>
                                    <span><strong>Proper Thickness:</strong> Sized to fit perfectly into standard sleeves without feeling too loose or too bulky.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5"></i>
                                    <span><strong>Opaque:</strong> The black core prevents see-through, essential for double-sided play.</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Feature 3: Flexibility -->
                    <div class="flex flex-col md:flex-row items-center gap-12">
                        <div class="w-full md:w-1/2 bg-slate-100 dark:bg-slate-900 rounded-2xl p-8 min-h-[300px] flex items-center justify-center relative overflow-hidden">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="w-16 h-24 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded shadow-sm"></div>
                                <div class="w-16 h-24 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded flex items-center justify-center text-slate-400 text-xs">Empty</div>
                                <div class="w-16 h-24 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded flex items-center justify-center text-slate-400 text-xs">Empty</div>
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 space-y-4">
                            <div class="inline-flex items-center gap-2 px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full text-xs font-bold uppercase tracking-wide">
                                <i data-lucide="wallet" class="w-3 h-3"></i> Cost Effective
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Zero Minimums</h3>
                            <p class="text-slate-600 dark:text-slate-300 leading-relaxed">
                                Most print shops force you to buy in batches of 18 or 54. We don't.
                            </p>

                            <ul class="space-y-3 text-sm text-slate-600 dark:text-slate-300">
                                <li class="flex items-start gap-3">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600 dark:text-green-400 shrink-0 mt-0.5"></i>
                                    <span><strong>Print Exactly What You Need:</strong> Need 1 commander replacement? 4 cards for a playset? 63 for a deck? You pay for exactly that count.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600 dark:text-green-400 shrink-0 mt-0.5"></i>
                                    <span><strong>No Wasted Money:</strong> Stop paying for blank filler cards just to meet a sheet quota.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-20">
                    <button onclick="startDesign()" class="bg-blue-600 hover:bg-blue-700 text-white px-12 py-5 rounded-lg font-bold text-xl shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-1">
                        Experience the Quality
                    </button>
                </div>
            </div>
        </div>
        
        <!-- CARD INSPECTOR MODAL (Preview Step) -->
        <div id="inspector-modal" class="fixed inset-0 bg-slate-900/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4">
            <div id="inspector-content" class="bg-white dark:bg-slate-850 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh] opacity-0 transform scale-95 transition-all duration-200">
                <!-- Header -->
                <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                    <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <i data-lucide="scan-search" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i> Card Inspector
                    </h3>
                    <button onclick="closeInspector()" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto bg-white dark:bg-slate-850">
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Front -->
                        <div class="space-y-3">
                            <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide text-center">Front</p>
                            <div class="aspect-[2.5/3.5] bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm relative group cursor-pointer" onclick="triggerCustomFrontUpload()">
                                <img id="inspector-front" class="w-full h-full object-cover">
                                
                                <!-- Upload New Overlay -->
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-20">
                                    <button class="bg-white text-slate-900 px-4 py-2 rounded-full text-xs font-bold shadow-lg hover:scale-105 transition-transform flex items-center gap-2">
                                        <i data-lucide="upload" class="w-3 h-3"></i> Upload New
                                    </button>
                                </div>

                                <!-- Inspector Change Art Button (Optional backup) -->
                                <div id="versions-btn-container" class="absolute bottom-4 left-0 w-full flex justify-center z-30" style="display: none;">
                                    <button onclick="event.stopPropagation(); openVersionsModal('inspector')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-xs font-bold shadow-xl flex items-center gap-2 transition-transform hover:scale-105 backdrop-blur-sm border border-white/20">
                                        <i data-lucide="images" class="w-3 h-3"></i> Change Version
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Back -->
                        <div class="space-y-3">
                            <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide text-center flex items-center justify-center gap-2">
                                Back 
                                <span id="back-status" class="text-[10px] bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-1.5 py-0.5 rounded-full hidden">Custom</span>
                            </p>
                            <div class="aspect-[2.5/3.5] bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm relative group cursor-pointer" onclick="triggerCustomBackUpload()">
                                <!-- Placeholder Text (Visible when img is hidden) -->
                                <div class="absolute inset-0 flex items-center justify-center text-slate-400 dark:text-slate-500 text-xs font-medium">No back added</div>
                                
                                <img id="inspector-back" class="w-full h-full object-cover bg-slate-50 dark:bg-slate-800 relative z-10">
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-20">
                                    <button class="bg-white text-slate-900 px-4 py-2 rounded-full text-xs font-bold shadow-lg hover:scale-105 transition-transform flex items-center gap-2">
                                        <i data-lucide="upload" class="w-3 h-3"></i> Change Back
                                    </button>
                                </div>
                            </div>
                            
                            <div class="text-center space-y-2 pt-2">
                                <button id="revert-btn" onclick="revertToGlobalBack()" class="hidden text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors font-medium border border-red-200 dark:border-red-900 px-3 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/30">
                                    Revert to Deck Back
                                </button>
                                <p class="text-[10px] text-slate-400 dark:text-slate-500">Click image to upload custom back for this card only.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex justify-between items-center">
                    <button onclick="removeCard(null, inspectorIndex)" class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-2 px-2 bg-red-50 dark:bg-red-900/20 py-1.5 rounded border border-red-100 dark:border-red-800">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Delete All Copies
                    </button>
                    <button onclick="closeInspector()" class="bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white px-5 py-2 rounded-lg font-medium text-sm transition-colors shadow">
                        Done
                    </button>
                </div>
            </div>
        </div>

        <!-- VERSIONS MODAL -->
        <div id="versions-modal" class="fixed inset-0 bg-slate-900/90 z-[80] hidden flex items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white dark:bg-slate-850 rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col">
                <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                    <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <i data-lucide="images" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i> Select Art Version
                    </h3>
                    <button onclick="closeVersionsModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="versions-grid" class="p-6 overflow-y-auto bg-slate-100 dark:bg-slate-950 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- Versions injected here -->
                    <div class="col-span-full text-center py-12 text-slate-400">Loading versions...</div>
                </div>
            </div>
        </div>

        <!-- CHECKOUT MODAL -->
        <div id="checkout-modal" class="fixed inset-0 bg-slate-900/90 z-[90] hidden flex items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white dark:bg-slate-850 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <!-- Header -->
                <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                    <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <i data-lucide="shopping-cart" class="w-5 h-5 text-green-600 dark:text-green-400"></i> Checkout
                    </h3>
                    <button onclick="closeCheckoutModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto bg-white dark:bg-slate-850">
                    <!-- Order Summary -->
                    <div class="mb-6 p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700">
                        <h4 class="font-bold text-slate-800 dark:text-white mb-3">Order Summary</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600 dark:text-slate-400" id="checkout-quantity">0 cards</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="checkout-cards-total">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600 dark:text-slate-400">Shipping</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="checkout-shipping">$0.00</span>
                            </div>
                            <div class="border-t border-slate-200 dark:border-slate-700 pt-2 mt-2 flex justify-between">
                                <span class="font-bold text-slate-900 dark:text-white">Total</span>
                                <span class="font-bold text-lg text-green-600 dark:text-green-400" id="checkout-total">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Form -->
                    <form id="checkout-form" onsubmit="handleCheckout(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email *</label>
                            <input type="email" id="checkout-email" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="your@email.com">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Full Name *</label>
                            <input type="text" id="checkout-name" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="John Doe">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Address Line 1 *</label>
                            <input type="text" id="checkout-line1" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="123 Main Street">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Address Line 2</label>
                            <input type="text" id="checkout-line2" class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Apartment, suite, etc.">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">City *</label>
                                <input type="text" id="checkout-city" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="New York">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">State/Province *</label>
                                <input type="text" id="checkout-state" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="NY">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">ZIP/Postal Code *</label>
                                <input type="text" id="checkout-postal" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="10001">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Country *</label>
                                <select id="checkout-country" required class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onchange="updateShippingCost()">
                                    <option value="">Select Country</option>
                                    <option value="US">United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="AU">Australia</option>
                                    <option value="DE">Germany</option>
                                    <option value="FR">France</option>
                                    <option value="OTHER">Other (International)</option>
                                </select>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                            <button type="submit" id="checkout-submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="lock" class="w-4 h-4"></i>
                                <span id="checkout-submit-text">Proceed to Payment</span>
                            </button>
                            <p class="text-xs text-slate-500 dark:text-slate-400 text-center mt-2">Secure payment powered by Stripe</p>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- IMPORT LIST MODAL -->
        <div id="import-modal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-white dark:bg-slate-850 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                    <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <i data-lucide="list" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i> Import Card List
                    </h3>
                    <button onclick="closeImportModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <!-- Content -->
                <div class="p-6 bg-white dark:bg-slate-850">
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Paste your card names below (one per line). Examples:</p>
                    <div class="bg-slate-50 dark:bg-slate-900 p-2 rounded border border-slate-200 dark:border-slate-700 text-xs text-slate-600 dark:text-slate-400 font-mono mb-3">
                        4 Lightning Bolt<br>
                        1 Satyr Wayfinder (M3C) 244<br>
                        1 Sol Ring (MPS) 24
                    </div>
                    <textarea id="import-text" class="w-full h-48 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-md p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none" placeholder="Enter cards here..."></textarea>
                    <div id="import-status" class="mt-2 text-xs text-slate-500 dark:text-slate-400 hidden">Processing...</div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex justify-end gap-3">
                     <button onclick="closeImportModal()" class="text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 px-4 py-2 text-sm font-medium">
                        Cancel
                    </button>
                     <button onclick="processCardList()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium text-sm transition-colors shadow flex items-center gap-2">
                        <i data-lucide="download-cloud" class="w-4 h-4"></i> Import Cards
                    </button>
                </div>
            </div>
        </div>

        <!-- Hidden File Input for Custom Back -->
        <input type="file" id="custom-back-upload" accept="image/*" class="hidden" onchange="handleCustomBackFile(this.files)">
        <!-- Hidden File Input for Custom Front -->
        <input type="file" id="custom-front-upload" accept="image/*" class="hidden" onchange="handleCustomFrontFile(this.files)">
        <!-- Hidden File Input for XML Upload -->
        <input type="file" id="xml-upload" accept=".xml" class="hidden" onchange="handleXMLFile(this.files)">

        <!-- VIEW 2: DESIGN STEPPER (Hidden initially) -->
        <div id="design-stepper" class="hidden h-full flex flex-col min-h-screen">
            <!-- Stepper Header -->
            <div class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shadow-sm sticky top-0 z-30 transition-colors">
                <div class="container mx-auto px-4">
                    <div class="flex items-center justify-between py-4">
                        <div class="flex space-x-8">
                            <button onclick="setStep(1)" id="step-btn-1" class="text-sm font-semibold pb-1 step-active flex items-center gap-2">
                                <span class="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center text-xs">1</span> Customize Front
                            </button>
                            <button onclick="setStep(2)" id="step-btn-2" class="text-sm font-semibold pb-1 step-inactive text-slate-500 dark:text-slate-400 flex items-center gap-2">
                                <span class="w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center text-xs">2</span> Customize Back
                            </button>
                            <button onclick="setStep(3)" id="step-btn-3" class="text-sm font-semibold pb-1 step-inactive text-slate-500 dark:text-slate-400 flex items-center gap-2">
                                <span class="w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center text-xs">3</span> Preview
                            </button>
                        </div>
                        <div class="flex items-center gap-4">
                             <div class="text-xs text-slate-500 dark:text-slate-400 text-right hidden sm:block">
                                <div class="font-bold text-slate-900 dark:text-white" id="total-price">Total: $0.00</div>
                                <div id="deck-stats">0 Cards • S33 Stock</div>
                            </div>
                            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md font-bold text-sm shadow-sm flex items-center gap-2">
                                <i data-lucide="shopping-cart" class="w-4 h-4"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workspace -->
            <div class="flex flex-col md:flex-row flex-grow h-full overflow-hidden">
                
                <!-- Sidebar Tools -->
                <div id="main-sidebar" class="w-full md:w-80 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col z-20 shadow-lg md:shadow-none transition-colors">
                    
                    <div class="flex-grow overflow-y-auto custom-scrollbar">
                        <!-- Print Prep Panel (New) -->
                        <div id="print-prep-panel" class="p-6 border-b border-slate-100 dark:border-slate-800 bg-blue-50/50 dark:bg-slate-850 hidden">
                            <h3 class="font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                                <i data-lucide="crop" class="w-4 h-4"></i> Print Prep
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400">Corner Trim</label>
                                        <span id="trim-value" class="text-xs font-mono text-slate-700 dark:text-slate-300">0mm</span>
                                    </div>
                                    <input type="range" id="trim-slider" min="0" max="3" step="0.5" value="0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updatePrepSettings()">
                                    <p class="text-[10px] text-slate-400 dark:text-slate-500 mt-1">Adjusts bleed start point (removes white corners)</p>
                                </div>

                                <div>
                                    <div class="flex justify-between mb-1">
                                        <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400">Bleed Adjustment</label>
                                        <span id="bleed-value" class="text-xs font-mono text-slate-700 dark:text-slate-300">2mm</span>
                                    </div>
                                    <input type="range" id="bleed-slider" min="-4" max="4" step="0.5" value="2" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updatePrepSettings()">
                                    <div class="flex justify-between text-[9px] text-slate-400 font-medium px-1 mt-1">
                                        <span>Trim (-4mm)</span>
                                        <span class="text-blue-600 dark:text-blue-400 font-bold">Target (+2mm)</span>
                                        <span>Extend (+4mm)</span>
                                    </div>
                                </div>

                                <button onclick="toggleBleed()" id="bleed-btn" class="w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 py-2 rounded-md text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="maximize" class="w-3 h-3"></i> <span id="bleed-btn-text">Add Bleed</span>
                                </button>
                                
                                <!-- Requirements Info Box -->
                                <div class="bg-blue-100/50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-2.5 space-y-2">
                                    <div class="flex gap-2 items-start">
                                        <i data-lucide="printer" class="w-3.5 h-3.5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5"></i>
                                        <p class="text-[10px] leading-tight text-slate-600 dark:text-slate-400">
                                            <strong class="text-slate-800 dark:text-slate-200">Standard Requirement:</strong> We need a <strong>2mm bleed</strong> extension past the cut line for reliable borderless printing.
                                        </p>
                                    </div>
                                    <div class="flex gap-2 items-start pt-1 border-t border-blue-200 dark:border-blue-800">
                                        <i data-lucide="scissors" class="w-3.5 h-3.5 text-orange-500 shrink-0 mt-0.5"></i>
                                        <p class="text-[10px] leading-tight text-slate-600 dark:text-slate-400">
                                            <strong class="text-slate-800 dark:text-slate-200">MPCFill / MPC Ready:</strong> These images often have large bleeds already. Set adjustment to <strong>-2mm</strong> to trim them to our spec.
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- APPLY TO ALL BUTTON -->
                                <div class="pt-2 border-t border-slate-200 dark:border-slate-700 mt-2">
                                    <button id="apply-all-btn" onclick="applyPrepToAll()" class="w-full bg-blue-100 dark:bg-blue-900/30 hover:bg-blue-200 dark:hover:bg-blue-900/50 text-blue-700 dark:text-blue-400 py-2 rounded-md text-xs font-bold transition-colors flex items-center justify-center gap-2 shadow-sm">
                                        <i data-lucide="copy" class="w-3 h-3"></i> Apply to All Cards
                                    </button>
                                    <p class="text-[10px] text-slate-400 dark:text-slate-500 text-center mt-1">Copies current trim/bleed settings to entire deck</p>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Panel -->
                        <div id="upload-panel" class="p-6 flex-grow">
                            <h3 id="upload-title" class="font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                                <i data-lucide="image-plus" class="w-4 h-4"></i> Upload Images
                            </h3>
                            
                            <input type="file" id="file-upload" multiple accept="image/*" class="hidden" onchange="handleFiles(this.files)">
                            
                            <div id="drop-zone" onclick="document.getElementById('file-upload').click()" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-6 text-center hover:bg-blue-50 dark:hover:bg-slate-800 hover:border-blue-400 dark:hover:border-blue-500 transition-colors cursor-pointer mb-6 group">
                                <i data-lucide="upload-cloud" class="w-8 h-8 text-slate-400 dark:text-slate-500 mx-auto mb-2 group-hover:text-blue-500 dark:group-hover:text-blue-400"></i>
                                <p id="upload-text" class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-blue-600 dark:group-hover:text-blue-400">Click to upload</p>
                                <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">JPG, PNG (Max 32MB)</p>
                            </div>

                            <!-- Progress Bar -->
                            <div id="processing-status" class="hidden mb-6">
                                <div class="flex justify-between text-xs font-semibold text-slate-600 dark:text-slate-400 mb-1">
                                    <span id="processing-text">Processing...</span>
                                    <span id="processing-percent">0%</span>
                                </div>
                                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                    <div id="processing-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>

                            <div id="import-btn-container" class="mb-6 space-y-2">
                                <button onclick="openImportModal()" class="w-full border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-2 rounded-md text-xs font-medium hover:bg-white dark:hover:bg-slate-700 hover:border-blue-300 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="list" class="w-3 h-3"></i> Import from Text List
                                </button>
                                
                                <!-- XML Upload Button -->
                                <button id="btn-xml-upload" onclick="document.getElementById('xml-upload').click()" class="w-full border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-2 rounded-md text-xs font-medium hover:bg-white dark:hover:bg-slate-700 hover:border-blue-300 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="file-code" class="w-3 h-3"></i> Upload XML (MPCFill)
                                </button>
                            </div>

                            <div class="space-y-2">
                                <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Instructions</p>
                                <p id="upload-desc" class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed">
                                    Upload your card art here. Each image will create a new card in your deck. Use the arrows in the main view to cycle through your cards.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar Footer (Next Button) -->
                    <div id="sidebar-footer" class="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 shrink-0">
                        <button id="sidebar-next-btn" onclick="setStep(2)" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-md flex items-center justify-center gap-2 transition-colors">
                            Next: Customize Back <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="flex-grow bg-slate-100 dark:bg-slate-950 canvas-area p-4 md:p-8 flex flex-col items-center justify-center relative overflow-hidden transition-colors">
                    
                    <div class="absolute top-4 left-4 bg-white/90 dark:bg-slate-800/90 backdrop-blur px-3 py-1.5 rounded shadow text-xs font-medium text-slate-600 dark:text-slate-300 z-10 flex gap-2">
                        <span>Canvas: 2.5" x 3.5"</span>
                        <span id="canvas-badge" class="hidden bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-2 rounded-sm font-bold">Common Back</span>
                    </div>

                    <!-- SINGLE EDITOR MODE (Step 1 & 2) -->
                    <div id="editor-view" class="flex flex-col items-center justify-center w-full h-full">
                        
                        <!-- Navigation Buttons (Hidden if 0 or 1 card) -->
                        <div id="deck-nav-controls" class="hidden items-center gap-4 mb-4 z-10">
                            <button onclick="prevCard()" class="bg-white dark:bg-slate-800 p-2 rounded-full shadow hover:bg-blue-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" title="Previous Card">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            
                            <div class="flex items-center gap-3 bg-white dark:bg-slate-800 rounded-full shadow pl-4 pr-2 py-1.5 transition-colors">
                                <span class="text-sm font-bold text-slate-700 dark:text-slate-200 min-w-[40px] text-center" id="card-counter">1 / 1</span>
                                <div class="w-px h-4 bg-slate-200 dark:bg-slate-600"></div>
                                <div class="flex items-center gap-1">
                                    <button onclick="updateQuantity(-1)" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 dark:text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" title="Decrease Quantity">
                                        <i data-lucide="minus" class="w-3 h-3"></i>
                                    </button>
                                    <span id="card-quantity-badge" class="text-xs font-bold text-blue-600 dark:text-blue-400 w-8 text-center">x1</span>
                                    <button onclick="updateQuantity(1)" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 dark:text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" title="Increase Quantity">
                                        <i data-lucide="plus" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>

                            <button onclick="nextCard()" class="bg-white dark:bg-slate-800 p-2 rounded-full shadow hover:bg-blue-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" title="Next Card">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- The Card Canvas -->
                        <!-- Changed w-[300px] to w-auto and added max-w to handle aspect ratio scaling -->
                        <div id="card-canvas" class="h-[420px] w-auto max-w-full bg-white dark:bg-slate-800 shadow-2xl rounded-xl relative border border-slate-200 dark:border-slate-700 transition-all duration-200 transform origin-center">
                            
                            <!-- Cut Line Indicator (Blue Dotted) -->
                            <div id="cut-line" class="absolute inset-0 border-2 border-cyan-500 border-dotted pointer-events-none z-40 hidden opacity-90">
                                <span class="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[9px] text-cyan-600 dark:text-cyan-400 font-bold font-mono bg-white dark:bg-slate-800 px-1.5 py-0.5 rounded shadow border border-cyan-100 dark:border-cyan-900 whitespace-nowrap">Cut Line (63x88mm)</span>
                            </div>

                            <!-- Content Container -->
                            <div id="canvas-content" class="w-full h-full rounded-lg overflow-hidden relative bg-white dark:bg-slate-800 group">
                                <!-- Default Placeholder -->
                                <div id="placeholder-content" class="w-full h-full flex flex-col items-center justify-center text-slate-300 dark:text-slate-600 p-8 text-center group">
                                    <i data-lucide="image" class="w-12 h-12 mb-2 opacity-50"></i>
                                    <p id="placeholder-text" class="text-sm font-medium">No Image Selected</p>
                                    <p class="text-xs opacity-75 mt-1">Upload an image to start</p>
                                </div>
                                <!-- Image Element (Created dynamically) -->
                                <img id="active-card-image" src="" class="hidden w-full h-full object-cover" alt="Card Art">
                            </div>
                        </div>

                        <!-- Versions Button Container (Moved below card) -->
                        <div id="editor-actions-btn" class="mt-6 flex justify-center gap-3 z-20 hidden">
                            <button onclick="openVersionsModal('editor')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-sm flex items-center gap-2 transition-colors border border-blue-700/20">
                                <i data-lucide="images" class="w-4 h-4"></i> Change Art
                            </button>
                            
                            <!-- Nano Banana Pro Button Removed -->
                        </div>
                    </div>

                    <!-- PREVIEW GRID MODE (Step 3) -->
                    <div id="preview-grid" class="hidden w-full h-full overflow-y-auto custom-scrollbar p-4">
                        <div id="grid-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 justify-items-center pb-20">
                            <!-- JS will populate this -->
                        </div>
                        <div id="empty-grid-msg" class="hidden flex-col items-center justify-center h-full text-slate-400 dark:text-slate-600">
                            <i data-lucide="layers" class="w-16 h-16 mb-4 opacity-50"></i>
                            <p>No cards created yet.</p>
                            <button onclick="setStep(1)" class="mt-4 text-blue-600 dark:text-blue-400 hover:underline">Go back and upload images</button>
                        </div>
                        <!-- Checkout Button (shown when cards exist) -->
                        <div id="checkout-button-container" class="hidden fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50">
                            <button onclick="openCheckoutModal()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg font-bold text-lg shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-1 flex items-center gap-3">
                                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                Proceed to Checkout
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </main>

    <script>
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            initHeroAnimation(); // Initialize the background cards

            const dropZone = document.getElementById('drop-zone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-active'); });
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-active'); handleFiles(e.dataTransfer.files); });
            }
        });

        // --- STATE MANAGEMENT ---
        let deck = [];
        let globalBack = { original: null, processed: null, trimMm: 0, bleedMm: 2, hasBleed: false };
        let currentCardIndex = -1;
        let currentStep = 1;
        let inspectorIndex = -1;
        let activeVersionIndex = -1;

        // --- HERO ANIMATION LOGIC ---
        function initHeroAnimation() {
            const container = document.getElementById('hero-bg-anim');
            if (!container) return;

            // Configuration for background cards
            // speed: parallax factor (higher = faster movement)
            // rot: initial rotation
            // pos: initial CSS position
            const cardsConfig = [
                { speed: 0.03, rot: -15, top: '10%', left: '5%', delay: '0s' },
                { speed: 0.05, rot: 10, top: '15%', right: '10%', delay: '1s' },
                { speed: 0.02, rot: -5, bottom: '20%', left: '15%', delay: '2s' },
                { speed: 0.04, rot: 20, bottom: '10%', right: '5%', delay: '0.5s' },
                { speed: 0.06, rot: 5, top: '40%', left: '45%', delay: '1.5s', opacity: 0.3 } // Middle subtle one
            ];

            container.innerHTML = ''; // Clear existing

            cardsConfig.forEach(conf => {
                const el = document.createElement('div');
                el.classList.add('bg-card-floater');
                
                // Set initial positions
                if (conf.top) el.style.top = conf.top;
                if (conf.bottom) el.style.bottom = conf.bottom;
                if (conf.left) el.style.left = conf.left;
                if (conf.right) el.style.right = conf.right;
                
                // Set animation delay so they don't bob in sync
                el.style.animationDelay = conf.delay;
                if (conf.opacity) el.style.opacity = conf.opacity;

                // Store data for parallax update
                el.dataset.speed = conf.speed;
                el.dataset.rot = conf.rot;

                // Initial Transform
                el.style.transform = `rotate(${conf.rot}deg)`;

                container.appendChild(el);
            });
        }

        function updateParallax(e) {
            const container = document.getElementById('hero-bg-anim');
            if (!container) return;

            const w = window.innerWidth;
            const h = window.innerHeight;
            
            // Mouse position relative to center of screen
            // Range: -0.5 to 0.5
            const mouseX = (e.clientX - (w / 2)) / w;
            const mouseY = (e.clientY - (h / 2)) / h;

            const cards = container.querySelectorAll('.bg-card-floater');
            
            cards.forEach(card => {
                const speed = parseFloat(card.dataset.speed);
                const rot = parseFloat(card.dataset.rot);
                
                // Calculate translation based on mouse position (inverted for depth feel)
                // Multiplied by arbitrary factor (e.g. 100px) to control max movement range
                const x = mouseX * speed * -1500; 
                const y = mouseY * speed * -1500;

                card.style.transform = `translate(${x}px, ${y}px) rotate(${rot}deg)`;
            });
        }

        // --- HELPER FUNCTIONS ---
        function safeClassList(id, action, className) {
            const el = document.getElementById(id);
            if (el) {
                if (action === 'add') el.classList.add(className);
                if (action === 'remove') el.classList.remove(className);
            }
        }

        function showProgress(show) {
            const el = document.getElementById('processing-status');
            if (el) {
                if(show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
        }

        function updateProgress(current, total, message) {
            const textEl = document.getElementById('processing-text');
            const percentEl = document.getElementById('processing-percent');
            const barEl = document.getElementById('processing-bar');
            
            if (textEl) textEl.innerText = message || 'Processing...';
            
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            if (percentEl) percentEl.innerText = `${percent}%`;
            if (barEl) barEl.style.width = `${percent}%`;
        }

        // --- THEME LOGIC ---
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
            }
        }

        // --- IMAGE PROCESSING (Trim & Bleed) ---
        function processImage(imgSrc, trimMm, bleedMm, addBleed, callback) {
            if (!imgSrc) {
                callback(null);
                return;
            }

            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const DPI = 300;
                const mmToPx = (mm) => Math.floor(mm * DPI / 25.4);
                
                const baseWidth = 750; 
                const baseHeight = 1050;
                
                const bleedPx = addBleed ? mmToPx(bleedMm) : 0;
                const trimPx = mmToPx(trimMm);

                // Calculate final canvas size
                // If bleedPx is negative (crop), the canvas is smaller than base
                const finalW = baseWidth + (bleedPx * 2);
                const finalH = baseHeight + (bleedPx * 2);
                
                canvas.width = finalW;
                canvas.height = finalH;

                // Standard draw coords
                const dx = bleedPx;
                const dy = bleedPx;
                const dw = baseWidth;
                const dh = baseHeight;
                
                // 1. Draw Full Image
                ctx.drawImage(img, 0, 0, img.width, img.height, dx, dy, dw, dh);

                // Only do stretch logic if we are actually adding bleed (positive)
                if (addBleed && bleedPx > 0) {
                    const getSafeColor = (x, y) => {
                        const pixel = ctx.getImageData(dx + x, dy + y, 1, 1).data;
                        return `rgba(${pixel[0]},${pixel[1]},${pixel[2]},${pixel[3]/255})`;
                    };

                    const colorTL = getSafeColor(trimPx, trimPx);
                    const colorTR = getSafeColor(dw - trimPx - 1, trimPx);
                    const colorBL = getSafeColor(trimPx, dh - trimPx - 1);
                    const colorBR = getSafeColor(dw - trimPx - 1, dh - trimPx - 1);

                    // Patch Corners
                    ctx.fillStyle = colorTL; ctx.fillRect(dx, dy, trimPx, trimPx);
                    ctx.fillStyle = colorTR; ctx.fillRect(dx + dw - trimPx, dy, trimPx, trimPx);
                    ctx.fillStyle = colorBL; ctx.fillRect(dx, dy + dh - trimPx, trimPx, trimPx);
                    ctx.fillStyle = colorBR; ctx.fillRect(dx + dw - trimPx, dy + dh - trimPx, trimPx, trimPx);

                    // Sides Stretch
                    ctx.drawImage(canvas, dx + trimPx, dy, dw - 2*trimPx, 1, dx + trimPx, 0, dw - 2*trimPx, bleedPx);
                    ctx.drawImage(canvas, dx + trimPx, dy + dh - 1, dw - 2*trimPx, 1, dx + trimPx, dy + dh, dw - 2*trimPx, bleedPx);
                    ctx.drawImage(canvas, dx, dy + trimPx, 1, dh - 2*trimPx, 0, dy + trimPx, bleedPx, dh - 2*trimPx);
                    ctx.drawImage(canvas, dx + dw - 1, dy + trimPx, 1, dh - 2*trimPx, dx + dw, dy + trimPx, bleedPx, dh - 2*trimPx);

                    // Corners Fill
                    ctx.fillStyle = colorTL; ctx.fillRect(0, 0, dx + trimPx, dy + trimPx);
                    ctx.fillStyle = colorTR; ctx.fillRect(dx + dw - trimPx, 0, bleedPx + trimPx, dy + trimPx);
                    ctx.fillStyle = colorBL; ctx.fillRect(0, dy + dh - trimPx, dx + trimPx, bleedPx + trimPx);
                    ctx.fillStyle = colorBR; ctx.fillRect(dx + dw - trimPx, dy + dh - trimPx, bleedPx + trimPx, bleedPx + trimPx);
                }

                callback(canvas.toDataURL());
            };
            img.onerror = () => {
                console.warn("Failed to load image for processing");
                callback(null); 
            }
            img.src = imgSrc;
        }

        // --- VIEW NAVIGATION ---
        function startDesign() {
            safeClassList('landing-view', 'add', 'hidden');
            safeClassList('how-it-works-view', 'add', 'hidden');
            safeClassList('pricing-view', 'add', 'hidden');
            safeClassList('why-us-view', 'add', 'hidden');
            safeClassList('main-nav-links', 'add', 'hidden');
            safeClassList('start-btn', 'add', 'hidden');
            safeClassList('main-footer', 'add', 'hidden');
            safeClassList('design-stepper', 'remove', 'hidden');
            
            const exitBtn = document.getElementById('exit-btn');
            if(exitBtn) { exitBtn.classList.remove('hidden'); exitBtn.classList.add('flex'); }
            
            window.scrollTo(0, 0);
            updateDeckStats();
            updateSidebarUI();
        }

        function showLanding() {
            safeClassList('landing-view', 'remove', 'hidden');
            safeClassList('how-it-works-view', 'add', 'hidden');
            safeClassList('pricing-view', 'add', 'hidden');
            safeClassList('why-us-view', 'add', 'hidden');
            safeClassList('main-nav-links', 'remove', 'hidden');
            safeClassList('start-btn', 'remove', 'hidden');
            safeClassList('main-footer', 'remove', 'hidden');
            safeClassList('design-stepper', 'add', 'hidden');
            const exitBtn = document.getElementById('exit-btn');
            if(exitBtn) { exitBtn.classList.add('hidden'); exitBtn.classList.remove('flex'); }
            window.scrollTo(0, 0);
        }

        function showHowItWorks() {
            safeClassList('landing-view', 'add', 'hidden');
            safeClassList('design-stepper', 'add', 'hidden');
            safeClassList('pricing-view', 'add', 'hidden');
            safeClassList('why-us-view', 'add', 'hidden');
            safeClassList('how-it-works-view', 'remove', 'hidden');
            
            // Ensure nav elements are visible
            safeClassList('main-nav-links', 'remove', 'hidden');
            safeClassList('start-btn', 'remove', 'hidden');
            
            const exitBtn = document.getElementById('exit-btn');
            if(exitBtn) { exitBtn.classList.add('hidden'); exitBtn.classList.remove('flex'); }
            
            window.scrollTo(0, 0);
            lucide.createIcons();
        }

        function showPricing() {
            safeClassList('landing-view', 'add', 'hidden');
            safeClassList('design-stepper', 'add', 'hidden');
            safeClassList('how-it-works-view', 'add', 'hidden');
            safeClassList('why-us-view', 'add', 'hidden');
            safeClassList('pricing-view', 'remove', 'hidden');
            
            // Ensure nav elements are visible
            safeClassList('main-nav-links', 'remove', 'hidden');
            safeClassList('start-btn', 'remove', 'hidden');
            
            const exitBtn = document.getElementById('exit-btn');
            if(exitBtn) { exitBtn.classList.add('hidden'); exitBtn.classList.remove('flex'); }
            
            window.scrollTo(0, 0);
            lucide.createIcons();
        }

        function showWhyUs() {
            safeClassList('landing-view', 'add', 'hidden');
            safeClassList('design-stepper', 'add', 'hidden');
            safeClassList('how-it-works-view', 'add', 'hidden');
            safeClassList('pricing-view', 'add', 'hidden');
            safeClassList('why-us-view', 'remove', 'hidden');
            
            // Ensure nav elements are visible
            safeClassList('main-nav-links', 'remove', 'hidden');
            safeClassList('start-btn', 'remove', 'hidden');
            
            const exitBtn = document.getElementById('exit-btn');
            if(exitBtn) { exitBtn.classList.add('hidden'); exitBtn.classList.remove('flex'); }
            
            window.scrollTo(0, 0);
            lucide.createIcons();
        }

        // --- STEPPER LOGIC ---
        function setStep(stepNum) {
            currentStep = stepNum;
            const steps = [1, 2, 3];
            steps.forEach(num => {
                const btn = document.getElementById(`step-btn-${num}`);
                const circle = btn.querySelector('span');
                if (num === stepNum) {
                    btn.classList.add('step-active', 'text-blue-600'); btn.classList.remove('step-inactive', 'text-slate-500');
                    circle.classList.add('bg-blue-100', 'text-blue-600'); circle.classList.remove('bg-slate-100', 'text-slate-500');
                } else {
                    btn.classList.remove('step-active', 'text-blue-600'); btn.classList.add('step-inactive', 'text-slate-500');
                    circle.classList.remove('bg-blue-100', 'text-blue-600'); circle.classList.add('bg-slate-100', 'text-slate-500');
                }
            });

            updateSidebarUI();
            const editorView = document.getElementById('editor-view');
            const previewGrid = document.getElementById('preview-grid');
            const canvasBadge = document.getElementById('canvas-badge');
            const prepPanel = document.getElementById('print-prep-panel');
            const mainSidebar = document.getElementById('main-sidebar');

            if (stepNum === 3) {
                editorView.classList.add('hidden');
                previewGrid.classList.remove('hidden');
                canvasBadge.classList.add('hidden');
                prepPanel.classList.add('hidden');
                if(mainSidebar) mainSidebar.classList.add('hidden'); // Hide sidebar completely in preview
                renderPreviewGrid();
            } else {
                editorView.classList.remove('hidden');
                previewGrid.classList.add('hidden');
                prepPanel.classList.remove('hidden'); 
                if(mainSidebar) mainSidebar.classList.remove('hidden'); // Show sidebar
                
                if (stepNum === 2) {
                    canvasBadge.classList.remove('hidden');
                    syncPrepControls(globalBack);
                } else {
                    canvasBadge.classList.add('hidden');
                    if (deck[currentCardIndex]) {
                        syncPrepControls(deck[currentCardIndex]);
                    }
                }
                updateCanvas();
            }
        }

        function syncPrepControls(dataObj) {
            const slider = document.getElementById('trim-slider');
            const trimVal = document.getElementById('trim-value');
            const bleedSlider = document.getElementById('bleed-slider');
            const bleedVal = document.getElementById('bleed-value');
            const btn = document.getElementById('bleed-btn');
            const btnText = document.getElementById('bleed-btn-text');

            slider.value = dataObj.trimMm || 0;
            trimVal.innerText = (dataObj.trimMm || 0) + 'mm';
            
            const currentBleed = dataObj.bleedMm !== undefined ? dataObj.bleedMm : 2;
            bleedSlider.value = currentBleed;
            bleedVal.innerText = currentBleed + 'mm';

            if (dataObj.hasBleed) {
                btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
                btnText.innerText = "Bleed Active";
            } else {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
                btnText.innerText = "Add Bleed";
            }
        }

        function updateSidebarUI() {
            const title = document.getElementById('upload-title');
            const text = document.getElementById('upload-text');
            const desc = document.getElementById('upload-desc');
            const prepPanel = document.getElementById('print-prep-panel');
            const importContainer = document.getElementById('import-btn-container');
            const nextBtn = document.getElementById('sidebar-next-btn');
            const xmlBtn = document.getElementById('btn-xml-upload');

            if (currentStep === 3) {
                prepPanel.classList.add('hidden');
            } else {
                prepPanel.classList.remove('hidden');
            }

            if (currentStep === 2) {
                title.innerHTML = '<i data-lucide="image-plus" class="w-4 h-4"></i> Upload Back';
                text.innerText = "Click to set Card Back";
                desc.innerText = "Upload an image here to set a common back for ALL cards, or use Import to set specific backs.";
                if(importContainer) importContainer.classList.remove('hidden');
                if(xmlBtn) xmlBtn.classList.add('hidden');
                
                if (nextBtn) {
                    nextBtn.innerHTML = 'Next: Preview Deck <i data-lucide="arrow-right" class="w-4 h-4"></i>';
                    nextBtn.onclick = () => setStep(3);
                }
            } else {
                title.innerHTML = '<i data-lucide="image-plus" class="w-4 h-4"></i> Upload Fronts';
                text.innerText = "Click to upload Cards";
                desc.innerText = "Upload your card art here. Each image will create a new card in your deck.";
                if(importContainer) importContainer.classList.remove('hidden');
                if(xmlBtn) xmlBtn.classList.remove('hidden');
                
                if (nextBtn) {
                    nextBtn.innerHTML = 'Next: Customize Back <i data-lucide="arrow-right" class="w-4 h-4"></i>';
                    nextBtn.onclick = () => setStep(2);
                }
            }
            lucide.createIcons();
        }

        // --- PRINT PREP HANDLERS ---
        function updatePrepSettings() {
            const trimMm = parseFloat(document.getElementById('trim-slider').value);
            const bleedMm = parseFloat(document.getElementById('bleed-slider').value);
            
            document.getElementById('trim-value').innerText = trimMm + 'mm';
            document.getElementById('bleed-value').innerText = bleedMm + 'mm';
            
            applyPrepToActive(trimMm, bleedMm, null); 
        }

        function updateOverlayGuides(bleedMm, hasBleed) {
            const cutLine = document.getElementById('cut-line');
            const canvasContainer = document.getElementById('card-canvas');
            
            // Standard TCG Dimensions
            const baseW = 63;
            const baseH = 88;
            
            // Calculate total canvas size in "units" (base + bleed)
            const activeBleed = hasBleed ? bleedMm : 0;
            
            const totalW = baseW + (2 * activeBleed);
            const totalH = baseH + (2 * activeBleed);
            
            if (canvasContainer) {
                canvasContainer.style.aspectRatio = `${totalW} / ${totalH}`;
            }
            
            const cutInsetX = (activeBleed / totalW) * 100;
            const cutInsetY = (activeBleed / totalH) * 100;
            
            cutLine.style.left = `${cutInsetX}%`;
            cutLine.style.right = `${cutInsetX}%`;
            cutLine.style.top = `${cutInsetY}%`;
            cutLine.style.bottom = `${cutInsetY}%`;

            // Cut Line is now always visible to show 63x88mm boundary
            if (hasBleed) {
                cutLine.classList.remove('hidden');
            } else {
                cutLine.classList.add('hidden');
            }
        }

        function toggleBleed() {
            let currentState = false;
            if (currentStep === 2) currentState = globalBack.hasBleed;
            else if (deck[currentCardIndex]) currentState = deck[currentCardIndex].hasBleed;

            applyPrepToActive(null, null, !currentState);
        }

        function applyPrepToActive(newTrim, newBleedMm, newBleedState) {
            let target = null;
            let originalSrc = null;

            if (currentStep === 2) {
                target = globalBack;
                originalSrc = globalBack.original;
            } else {
                if (currentCardIndex < 0 || !deck[currentCardIndex]) return;
                target = deck[currentCardIndex];
                originalSrc = target.originalFront;
            }

            if (!originalSrc) return;

            if (newTrim !== null) target.trimMm = newTrim;
            if (newBleedMm !== null) target.bleedMm = newBleedMm;
            if (newBleedState !== null) target.hasBleed = newBleedState;

            if (target.bleedMm === undefined) target.bleedMm = 2;

            syncPrepControls(target);
            
            updateOverlayGuides(target.bleedMm, target.hasBleed);

            processImage(originalSrc, target.trimMm, target.bleedMm, target.hasBleed, (processedData) => {
                if (currentStep === 2) {
                    globalBack.processed = processedData;
                } else {
                    target.front = processedData;
                }
                
                if (currentStep !== 2 && target.originalBack) {
                     processImage(target.originalBack, target.trimMm, target.bleedMm, target.hasBleed, (processedBack) => {
                        target.back = processedBack;
                        updateCanvas(); 
                    });
                } else {
                    updateCanvas(); 
                }
            });
        }

        async function applyPrepToAll() {
            const trimMm = parseFloat(document.getElementById('trim-slider').value);
            const bleedMm = parseFloat(document.getElementById('bleed-slider').value);
            
            let activeState = false;
            if (currentStep === 2) activeState = globalBack.hasBleed;
            else if (deck[currentCardIndex]) activeState = deck[currentCardIndex].hasBleed;
            
            const btn = document.getElementById('apply-all-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Processing...';
            btn.disabled = true;

            const promises = deck.map(async (card) => {
                card.trimMm = trimMm;
                card.bleedMm = bleedMm;
                card.hasBleed = activeState;
                
                const p1 = new Promise(resolve => {
                    processImage(card.originalFront, trimMm, bleedMm, activeState, (processed) => {
                        card.front = processed;
                        resolve();
                    });
                });
                
                const p2 = card.originalBack ? new Promise(resolve => {
                    processImage(card.originalBack, trimMm, bleedMm, activeState, (processed) => {
                        card.back = processed;
                        resolve();
                    });
                }) : Promise.resolve();

                return Promise.all([p1, p2]);
            });

            await Promise.all(promises);
            
            updateCanvas(); 
            
            btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Applied to All';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }, 2000);
            lucide.createIcons();
        }

        // --- FILE UPLOAD HANDLING ---
        async function handleFiles(files) {
            const fileList = Array.from(files);
            if (fileList.length === 0) return;

            if (currentStep === 2) {
                if (fileList.length > 0) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const original = e.target.result;
                        globalBack.original = original;
                        globalBack.trimMm = 0;
                        globalBack.bleedMm = 2;
                        globalBack.hasBleed = false;
                        
                        processImage(original, 0, 2, false, (processed) => {
                            globalBack.processed = processed;
                            syncPrepControls(globalBack);
                            updateCanvas();
                        });
                    };
                    reader.readAsDataURL(fileList[0]);
                }
            } else {
                const imageFiles = fileList.filter(f => f.type.startsWith('image/'));
                const total = imageFiles.length;
                if (total === 0) return;

                showProgress(true);

                for (let i = 0; i < total; i++) {
                    updateProgress(i, total, `Processing image ${i + 1} of ${total}`);
                    const file = imageFiles[i];
                    
                    await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const original = e.target.result;
                            processImage(original, 0, 2, false, (processed) => {
                                deck.push({
                                    id: Date.now() + Math.random(),
                                    originalFront: original,
                                    front: processed,
                                    back: null,
                                    originalBack: null,
                                    trimMm: 0,
                                    bleedMm: 2,
                                    hasBleed: false,
                                    quantity: 1
                                });
                                resolve();
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                }

                if (deck.length > 0 && currentCardIndex === -1) {
                    currentCardIndex = 0;
                }
                
                if (currentStep === 1) {
                    syncPrepControls(deck[currentCardIndex]);
                    updateCanvas();
                }
                
                updateDeckStats();
                updateProgress(total, total, 'Done!');
                setTimeout(() => showProgress(false), 500);
            }
        }
        
        // --- XML FILE HANDLING ---
        function handleXMLFile(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const xmlText = e.target.result;
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                
                const fronts = xmlDoc.querySelectorAll("fronts > card");
                const backs = xmlDoc.querySelectorAll("backs > card");
                const cardbackNode = xmlDoc.querySelector("cardback");
                
                const getDriveUrl = (id) => `https://lh3.googleusercontent.com/d/${id}=w1000`;
                
                const btnContainer = document.getElementById('import-btn-container');
                // Don't replace the buttons with text, we use the progress bar now
                // But we can disable them
                
                showProgress(true);
                updateProgress(0, 100, 'Parsing XML...');
                lucide.createIcons();

                try {
                    if (cardbackNode && cardbackNode.textContent) {
                        const backId = cardbackNode.textContent;
                        const backUrl = getDriveUrl(backId);
                        await new Promise(resolve => {
                             const img = new Image();
                             img.crossOrigin = "Anonymous";
                             img.onload = () => {
                                 const canvas = document.createElement('canvas');
                                 canvas.width = img.width; canvas.height = img.height;
                                 canvas.getContext('2d').drawImage(img,0,0);
                                 const dataUrl = canvas.toDataURL();
                                 
                                 globalBack.original = dataUrl;
                                 processImage(dataUrl, 0, 2, false, (processed) => {
                                     globalBack.processed = processed;
                                     resolve();
                                 });
                             };
                             img.onerror = () => resolve(); 
                             img.src = backUrl;
                        });
                    }
    
                    if (currentStep === 2) {
                        const backMap = new Map();
                        
                        backs.forEach(node => {
                            const id = node.querySelector("id")?.textContent;
                            const slotsText = node.querySelector("slots")?.textContent;
                            if (id && slotsText) {
                                const url = getDriveUrl(id);
                                const slots = slotsText.split(',').map(s => parseInt(s.trim()));
                                slots.forEach(slot => {
                                    backMap.set(slot, url);
                                });
                            }
                        });
    
                        const sortedSlots = Array.from(backMap.keys()).sort((a,b) => a - b);
                        const totalSlots = sortedSlots.length;
                        
                        for (let i = 0; i < totalSlots; i++) {
                            const slot = sortedSlots[i];
                            updateProgress(i, totalSlots, `Processing back for card ${slot + 1}`);
                            
                            if (slot < deck.length) {
                                const backUrl = backMap.get(slot);
                                
                                await new Promise(resolve => {
                                    const img = new Image();
                                    img.crossOrigin = "Anonymous";
                                    img.onload = () => {
                                        const canvas = document.createElement('canvas');
                                        canvas.width = img.width; canvas.height = img.height;
                                        canvas.getContext('2d').drawImage(img,0,0);
                                        const dataUrl = canvas.toDataURL();
                                        
                                        const card = deck[slot];
                                        card.originalBack = dataUrl;
                                        
                                        processImage(dataUrl, card.trimMm, card.bleedMm, card.hasBleed, (processed) => {
                                            card.back = processed;
                                            resolve();
                                        });
                                    };
                                    img.onerror = () => resolve();
                                    img.src = backUrl;
                                });
                            }
                        }
    
                    } else {
                        const slotMap = new Map(); 
                        
                        fronts.forEach(node => {
                            const id = node.querySelector("id")?.textContent;
                            const slotsText = node.querySelector("slots")?.textContent;
                            if (id && slotsText) {
                                const url = getDriveUrl(id);
                                const slots = slotsText.split(',').map(s => parseInt(s.trim()));
                                slots.forEach(slot => {
                                    if(!slotMap.has(slot)) slotMap.set(slot, {});
                                    slotMap.get(slot).front = url;
                                });
                            }
                        });
                        
                        backs.forEach(node => {
                            const id = node.querySelector("id")?.textContent;
                            const slotsText = node.querySelector("slots")?.textContent;
                            if (id && slotsText) {
                                const url = getDriveUrl(id);
                                const slots = slotsText.split(',').map(s => parseInt(s.trim()));
                                slots.forEach(slot => {
                                    if(!slotMap.has(slot)) slotMap.set(slot, {});
                                    slotMap.get(slot).back = url;
                                });
                            }
                        });
                        
                        const sortedSlots = Array.from(slotMap.keys()).sort((a,b) => a - b);
                        const totalSlots = sortedSlots.length;
                        
                        for (let i = 0; i < totalSlots; i++) {
                            const slot = sortedSlots[i];
                            updateProgress(i, totalSlots, `Processing card ${slot + 1} of ${totalSlots}`);
                            
                            const data = slotMap.get(slot);
                            if (!data.front) continue;
                            
                            const pFront = new Promise(resolve => {
                                 const img = new Image();
                                 img.crossOrigin = "Anonymous";
                                 img.onload = () => {
                                     const canvas = document.createElement('canvas');
                                     canvas.width = img.width; canvas.height = img.height;
                                     canvas.getContext('2d').drawImage(img,0,0);
                                     resolve(canvas.toDataURL());
                                 };
                                 img.onerror = () => resolve(null);
                                 img.src = data.front;
                            });
                            
                            const pBack = data.back ? new Promise(resolve => {
                                 const img = new Image();
                                 img.crossOrigin = "Anonymous";
                                 img.onload = () => {
                                     const canvas = document.createElement('canvas');
                                     canvas.width = img.width; canvas.height = img.height;
                                     canvas.getContext('2d').drawImage(img,0,0);
                                     resolve(canvas.toDataURL());
                                 };
                                 img.onerror = () => resolve(null);
                                 img.src = data.back;
                            }) : Promise.resolve(null);
                            
                            const [frontData, backData] = await Promise.all([pFront, pBack]);
                            
                            if (frontData) {
                                 await new Promise(resolve => {
                                     processImage(frontData, 0, 2, false, (pFront) => {
                                       if (backData) {
                                            processImage(backData, 0, 2, false, (pBack) => {
                                                 deck.push({
                                                     id: Date.now() + Math.random(),
                                                     originalFront: frontData,
                                                     front: pFront,
                                                     originalBack: backData,
                                                     back: pBack,
                                                     trimMm: 0,
                                                     bleedMm: 2,
                                                     hasBleed: false,
                                                     quantity: 1
                                                 });
                                                 resolve();
                                            });
                                       } else {
                                            deck.push({
                                                id: Date.now() + Math.random(),
                                                originalFront: frontData,
                                                front: pFront,
                                                originalBack: null,
                                                back: null,
                                                trimMm: 0,
                                                bleedMm: 2,
                                                hasBleed: false,
                                                quantity: 1
                                            });
                                            resolve();
                                       }
                                    });
                                 });
                            }
                        }
                    }
                } catch (err) {
                    console.error("XML processing error", err);
                } finally {
                    if (deck.length > 0 && currentCardIndex === -1) currentCardIndex = 0;
                    
                    updateDeckStats();
                    updateCanvas();
                    updateSidebarUI();
                    lucide.createIcons();
                    
                    updateProgress(100, 100, 'Done!');
                    setTimeout(() => showProgress(false), 500);
                }
            };
            reader.readAsText(file);
            document.getElementById('xml-upload').value = '';
        }

        // --- SCRYFALL IMPORT LOGIC ---
        function openImportModal() {
            const modal = document.getElementById('import-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeImportModal() {
            const modal = document.getElementById('import-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('import-text').value = '';
            document.getElementById('import-status').classList.add('hidden');
        }

        async function processCardList() {
            const text = document.getElementById('import-text').value;
            const status = document.getElementById('import-status');
            const lines = text.split('\n').filter(l => l.trim().length > 0);
            const cardRequests = [];
            
            lines.forEach(line => {
                line = line.trim();
                const specificMatch = line.match(/^(\d+)\s+(.+?)\s+\(([\w\d]+)\)\s+([\w\d]+)\s*$/);
                if (specificMatch) {
                    cardRequests.push({ 
                        qty: parseInt(specificMatch[1]), 
                        identifier: { set: specificMatch[3].toLowerCase(), collector_number: specificMatch[4] } 
                    });
                } else {
                    const match = line.match(/^(\d+)\s*[xX]?\s+(.*)/);
                    if (match) {
                        cardRequests.push({ qty: parseInt(match[1]), identifier: { name: match[2] } });
                    } else {
                        cardRequests.push({ qty: 1, identifier: { name: line } });
                    }
                }
            });

            if (cardRequests.length === 0) return;
            // Use the new progress bar instead of the modal status
            closeImportModal();
            showProgress(true);
            updateProgress(0, 100, `Fetching ${cardRequests.length} unique entries...`);

            const uniqueIdentifiersMap = new Map();
            cardRequests.forEach(req => {
                uniqueIdentifiersMap.set(JSON.stringify(req.identifier), req.identifier);
            });
            
            const identifiersToFetch = Array.from(uniqueIdentifiersMap.values());
            const chunks = [];
            for (let i = 0; i < identifiersToFetch.length; i += 75) {
                chunks.push(identifiersToFetch.slice(i, i + 75));
            }

            const allFoundCards = [];

            try {
                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    updateProgress(i, chunks.length, `Fetching batch ${i + 1} of ${chunks.length}...`);
                    const payload = { identifiers: chunk };
                    const response = await fetch('https://api.scryfall.com/cards/collection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (data.data) allFoundCards.push(...data.data);
                }

                // Note: imagesToAssign logic for Backs (Step 2) kept simple (1 qty per push) for now 
                // as mixing grouped logic with back assignment is complex. 
                // Focusing on Deck Import (Step 1 context).
                const imagesToAssign = []; 
                const totalReqs = cardRequests.length;

                for (let i = 0; i < totalReqs; i++) {
                    const req = cardRequests[i];
                    updateProgress(i, totalReqs, `Processing card ${i+1} of ${totalReqs}: ${req.identifier.name || req.identifier.set}`);
                    
                    let cardData = null;
                    if (req.identifier.set && req.identifier.collector_number) {
                        cardData = allFoundCards.find(c => 
                            c.set.toLowerCase() === req.identifier.set.toLowerCase() && 
                            c.collector_number === req.identifier.collector_number
                        );
                    } else if (req.identifier.name) {
                        cardData = allFoundCards.find(c => c.name && c.name.toLowerCase().includes(req.identifier.name.toLowerCase()));
                    }

                    if (cardData) {
                        let frontImgSrc = null;
                        let backImgSrc = null;

                        if (cardData.card_faces && cardData.card_faces.length > 1 && cardData.card_faces[1].image_uris) {
                            frontImgSrc = cardData.card_faces[0].image_uris.large;
                            backImgSrc = cardData.card_faces[1].image_uris.large;
                        } else if (cardData.image_uris) {
                            frontImgSrc = cardData.image_uris.large;
                        }

                        if (frontImgSrc) {
                            await new Promise((resolve) => {
                                const pFront = new Promise(r => processImage(frontImgSrc, 0, 2, false, r));
                                const pBack = backImgSrc ? new Promise(r => processImage(backImgSrc, 0, 2, false, r)) : Promise.resolve(null);

                                Promise.all([pFront, pBack]).then(([processedFront, processedBack]) => {
                                    if (currentStep === 2) {
                                        // Back import mode: keep pushing individual entries for now to fill slots
                                        for(let k=0; k<req.qty; k++) {
                                            imagesToAssign.push({ original: frontImgSrc, processed: processedFront });
                                        }
                                    } else {
                                        // Deck import mode: GROUP them!
                                        deck.push({
                                            id: Date.now() + Math.random(),
                                            originalFront: frontImgSrc,
                                            front: processedFront,
                                            back: processedBack, 
                                            originalBack: backImgSrc,
                                            trimMm: 0,
                                            bleedMm: 2,
                                            hasBleed: false,
                                            printsUri: cardData.prints_search_uri,
                                            quantity: req.qty // Store the grouping quantity
                                        });
                                    }
                                    resolve();
                                });
                            });
                        }
                    }
                }

                if (currentStep === 2 && imagesToAssign.length > 0) {
                    const limit = Math.min(deck.length, imagesToAssign.length);
                    for(let i=0; i<limit; i++) {
                        updateProgress(i, limit, `Applying back to card ${i + 1}...`);
                        const newBack = imagesToAssign[i];
                        const card = deck[i];
                        card.originalBack = newBack.original;
                        await new Promise(resolve => {
                             processImage(newBack.original, card.trimMm, card.bleedMm, card.hasBleed, (reProcessed) => {
                                 card.back = reProcessed;
                                 resolve();
                             });
                        });
                    }
                }

                if (deck.length > 0 && currentCardIndex === -1) currentCardIndex = 0;
                updateDeckStats();
                updateCanvas();
                updateProgress(100, 100, 'Import Complete!');
                setTimeout(() => showProgress(false), 500);
            } catch (error) {
                console.error(error);
                showProgress(false);
                alert("Error importing cards. Please check the console.");
            }
        }

        // --- VERSIONS MODAL LOGIC ---
        function openVersionsModal(context) {
            const modal = document.getElementById('versions-modal');
            const grid = document.getElementById('versions-grid');
            
            if (context === 'editor') {
                activeVersionIndex = currentCardIndex;
            } else {
                activeVersionIndex = inspectorIndex;
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400">Loading versions...</div>';

            if(activeVersionIndex >= 0 && deck[activeVersionIndex] && deck[activeVersionIndex].printsUri) {
                fetchVersions(deck[activeVersionIndex].printsUri);
            } else {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400">No versions available for this card.</div>';
            }
        }

        function closeVersionsModal() {
            const modal = document.getElementById('versions-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function fetchVersions(uri) {
            try {
                const response = await fetch(uri);
                const data = await response.json();
                renderVersions(data.data);
            } catch (error) {
                console.error(error);
                document.getElementById('versions-grid').innerHTML = '<div class="col-span-full text-center py-12 text-red-400">Error loading versions.</div>';
            }
        }

        function renderVersions(cards) {
            const grid = document.getElementById('versions-grid');
            grid.innerHTML = '';

            if(!cards || cards.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400">No other versions found.</div>';
                return;
            }

            cards.forEach(card => {
                let imgSrc = null;
                if (card.image_uris && card.image_uris.normal) {
                    imgSrc = card.image_uris.normal; 
                } else if (card.card_faces && card.card_faces[0].image_uris) {
                    imgSrc = card.card_faces[0].image_uris.normal;
                }
                
                let largeImg = null;
                if (card.image_uris && card.image_uris.large) {
                    largeImg = card.image_uris.large; 
                } else if (card.card_faces && card.card_faces[0].image_uris) {
                    largeImg = card.card_faces[0].image_uris.large;
                }

                if (imgSrc && largeImg) {
                    const div = document.createElement('div');
                    div.className = 'aspect-[2.5/3.5] cursor-pointer hover:scale-105 transition-transform shadow-sm rounded overflow-hidden border border-slate-200';
                    div.onclick = () => selectVersion(largeImg);
                    div.innerHTML = `
                        <img src="${imgSrc}" class="w-full h-full object-cover">
                        <div class="bg-white text-[10px] text-center py-1 font-mono text-slate-600 border-t border-slate-100">
                            ${card.set_name}
                        </div>
                    `;
                    grid.appendChild(div);
                }
            });
        }

        function selectVersion(newImgUrl) {
            if (activeVersionIndex >= 0 && deck[activeVersionIndex]) {
                const card = deck[activeVersionIndex];
                card.originalFront = newImgUrl;
                processImage(newImgUrl, card.trimMm, card.bleedMm, card.hasBleed, (processed) => {
                    card.front = processed;
                    if (currentStep === 1 && currentCardIndex === activeVersionIndex) {
                        updateCanvas();
                    } else if (currentStep === 3 && inspectorIndex === activeVersionIndex) {
                        document.getElementById('inspector-front').src = processed;
                        renderPreviewGrid();
                    }
                    closeVersionsModal();
                });
            }
        }

        // --- NANO BANANA PRO LOGIC REMOVED ---

        // --- CANVAS RENDERING ---
        function updateCanvas() {
            const placeholder = document.getElementById('placeholder-content');
            const placeholderText = document.getElementById('placeholder-text');
            const activeImage = document.getElementById('active-card-image');
            const navControls = document.getElementById('deck-nav-controls');
            const counter = document.getElementById('card-counter');
            const qtyBadge = document.getElementById('card-quantity-badge');
            const bleedIndicator = document.getElementById('cut-line');
            const editorActionsBtn = document.getElementById('editor-actions-btn');

            if (currentStep === 1 && deck.length > 0) {
                navControls.classList.remove('hidden'); navControls.classList.add('flex');
                counter.innerText = `${currentCardIndex + 1} / ${deck.length}`;
                
                // Update Quantity Badge
                const currentQty = deck[currentCardIndex] ? (deck[currentCardIndex].quantity || 1) : 1;
                if(qtyBadge) qtyBadge.innerText = `x${currentQty}`;
                
            } else {
                navControls.classList.add('hidden'); navControls.classList.remove('flex');
            }

            let imageToShow = null;
            let currentBleedMm = 2;
            let currentHasBleed = false;

            if (currentStep === 2) {
                imageToShow = globalBack.processed;
                currentBleedMm = globalBack.bleedMm !== undefined ? globalBack.bleedMm : 2;
                currentHasBleed = globalBack.hasBleed;
                placeholderText.innerText = "No Back Selected";
                if (editorActionsBtn) editorActionsBtn.style.display = 'none';
            } else {
                if (currentCardIndex >= 0 && deck[currentCardIndex]) {
                    imageToShow = deck[currentCardIndex].front;
                    currentBleedMm = deck[currentCardIndex].bleedMm !== undefined ? deck[currentCardIndex].bleedMm : 2;
                    currentHasBleed = deck[currentCardIndex].hasBleed;
                    
                    if (editorActionsBtn) editorActionsBtn.style.display = 'flex';

                    if(deck[currentCardIndex]) syncPrepControls(deck[currentCardIndex]);
                } else {
                    placeholderText.innerText = "No Image Selected";
                    if (editorActionsBtn) editorActionsBtn.style.display = 'none';
                }
            }
            
            updateOverlayGuides(currentBleedMm, currentHasBleed);

            if (imageToShow) {
                placeholder.classList.add('hidden');
                activeImage.classList.remove('hidden');
                activeImage.src = imageToShow;
            } else {
                placeholder.classList.remove('hidden');
                activeImage.classList.add('hidden');
                activeImage.src = "";
            }
        }

        function renderPreviewGrid() {
            const gridContainer = document.getElementById('grid-container');
            const emptyMsg = document.getElementById('empty-grid-msg');
            const checkoutBtn = document.getElementById('checkout-button-container');
            gridContainer.innerHTML = '';

            if (deck.length === 0) {
                emptyMsg.classList.remove('hidden'); emptyMsg.classList.add('flex');
                if (checkoutBtn) checkoutBtn.classList.add('hidden');
            } else {
                emptyMsg.classList.add('hidden'); emptyMsg.classList.remove('flex');
                if (checkoutBtn) checkoutBtn.classList.remove('hidden');
                
                let visualIndex = 1;

                deck.forEach((cardGroup, groupIndex) => {
                    // Loop through the quantity of each card group
                    const quantity = cardGroup.quantity || 1;
                    
                    for(let i = 0; i < quantity; i++) {
                        const wrapper = document.createElement('div');
                        wrapper.className = "flex flex-col gap-2 w-[150px]";

                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'flip-card w-full h-[210px] cursor-pointer relative group';
                        
                        const inner = document.createElement('div');
                        inner.className = 'flip-card-inner shadow-md rounded-lg';
                        
                        inner.onclick = (e) => {
                            // When clicking a specific card, we inspect the Group it belongs to
                            openInspector(groupIndex);
                        };

                        let backImgSrc = null;
                        if (cardGroup.back) backImgSrc = cardGroup.back;
                        else if (globalBack.processed) backImgSrc = globalBack.processed;
                        else if (globalBack.original) backImgSrc = globalBack.original;

                        let backContent = backImgSrc 
                            ? `<img src="${backImgSrc}" class="w-full h-full object-cover">` 
                            : `<div class="w-full h-full flex items-center justify-center bg-slate-100 dark:bg-slate-700 text-slate-400 dark:text-slate-500 text-xs font-medium p-4 text-center">No back added</div>`;

                        inner.innerHTML = `
                            <div class="flip-card-front bg-white dark:bg-slate-800">
                                <img src="${cardGroup.front}" class="w-full h-full object-cover">
                                <div class="absolute bottom-0 left-0 w-full bg-slate-900/70 text-white text-[10px] py-1 text-center opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-1">
                                    <i data-lucide="search" class="w-3 h-3"></i> Inspect
                                </div>
                            </div>
                            <div class="flip-card-back bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                                ${backContent}
                            </div>
                        `;

                        const controlBar = document.createElement('div');
                        controlBar.className = "flex justify-between items-center px-1 bg-slate-50 dark:bg-slate-800 rounded-md border border-slate-200 dark:border-slate-700 py-1";
                        
                        const label = document.createElement('span');
                        label.className = "text-[10px] font-mono text-slate-500 dark:text-slate-400 font-bold pl-1";
                        label.innerText = `#${visualIndex}`;

                        const delBtn = document.createElement('button');
                        delBtn.className = "text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/30 p-1 rounded transition-colors flex items-center gap-1 text-[10px] font-bold uppercase tracking-wide";
                        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-3 h-3"></i> Remove';
                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            // In preview mode, removing a card means removing 1 INSTANCE from the group
                            removeCardInstance(groupIndex);
                        };

                        controlBar.appendChild(label);
                        controlBar.appendChild(delBtn);

                        cardDiv.appendChild(inner);
                        wrapper.appendChild(cardDiv);
                        wrapper.appendChild(controlBar);
                        gridContainer.appendChild(wrapper);
                        
                        visualIndex++;
                    }
                });
                
                lucide.createIcons();
            }
        }

        // --- REMOVE CARD LOGIC ---
        
        // Remove a single instance (used in Preview)
        function removeCardInstance(groupIndex) {
            if (confirm('Remove this copy?')) {
                if (deck[groupIndex]) {
                    if (deck[groupIndex].quantity > 1) {
                        deck[groupIndex].quantity--;
                    } else {
                        deck.splice(groupIndex, 1);
                    }
                    updateDeckStats();
                    renderPreviewGrid();
                }
            }
        }

        // --- QUANTITY LOGIC ---
        function updateQuantity(change) {
            if (currentCardIndex < 0 || !deck[currentCardIndex]) return;
            
            const card = deck[currentCardIndex];
            if (card.quantity === undefined) card.quantity = 1;
            
            const newQty = card.quantity + change;
            
            if (newQty < 1) {
                // If decreasing below 1, trigger removal of the whole group
                removeCard(null, currentCardIndex);
            } else {
                card.quantity = newQty;
                updateDeckStats();
                updateCanvas();
            }
        }

        // Remove entire group (used in Editor)
        function removeCard(e, index) {
            if (e && e.stopPropagation) {
                e.stopPropagation();
                e.preventDefault();
            }

            const targetIndex = (index !== null && index !== undefined) ? index : currentCardIndex;

            if (targetIndex < 0 || targetIndex >= deck.length) return;

            // In Step 1, we delete the whole group
            if (confirm('Are you sure you want to remove this card group?')) {
                deck.splice(targetIndex, 1);
                
                if (deck.length === 0) {
                    currentCardIndex = -1;
                } else if (currentCardIndex >= deck.length) {
                    currentCardIndex = deck.length - 1;
                } else if (currentCardIndex > targetIndex) {
                    currentCardIndex--;
                }

                updateDeckStats();
                
                if (currentStep === 3) {
                    renderPreviewGrid();
                }
                
                if (currentStep !== 3) {
                    if (deck.length > 0) syncPrepControls(deck[currentCardIndex]);
                    updateCanvas();
                }
                
                const modal = document.getElementById('inspector-modal');
                if (!modal.classList.contains('hidden')) closeInspector();
            }
        }

        function openInspector(index) {
            inspectorIndex = index;
            const card = deck[index];
            const modal = document.getElementById('inspector-modal');
            const content = document.getElementById('inspector-content');
            const versionBtn = document.getElementById('versions-btn-container');
            const footer = modal.querySelector('.bg-slate-50.text-right, .bg-slate-50.flex'); 

            document.getElementById('inspector-front').src = card.front; 
            
            // In Inspector, "Delete Card" deletes the whole group currently, 
            // as inspecting implies looking at the Group configuration.
            if(footer) {
                footer.className = "p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex justify-between items-center";
                footer.innerHTML = `
                    <button onclick="removeCard(null, ${index})" class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-2 px-2 bg-red-50 dark:bg-red-900/20 py-1.5 rounded border border-red-100 dark:border-red-800">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Delete All Copies
                    </button>
                    <button onclick="closeInspector()" class="bg-slate-800 hover:bg-slate-900 text-white px-5 py-2 rounded-lg font-medium text-sm transition-colors shadow">
                        Done
                    </button>
                `;
            }
            
            if(card.printsUri) {
                versionBtn.style.display = 'flex';
            } else {
                versionBtn.style.display = 'none';
            }

            updateInspectorUI();
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { content.classList.remove('opacity-0', 'scale-95'); content.classList.add('opacity-100', 'scale-100'); }, 10);
            lucide.createIcons();
        }

        function closeInspector() {
            const modal = document.getElementById('inspector-modal');
            const content = document.getElementById('inspector-content');
            content.classList.remove('opacity-100', 'scale-100'); content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 200);
            renderPreviewGrid();
        }

        function triggerCustomBackUpload() {
            const input = document.getElementById('custom-back-upload');
            if (input) { input.value = null; input.click(); }
        }
        
        function triggerCustomFrontUpload() {
            const input = document.getElementById('custom-front-upload');
            if (input) { input.value = null; input.click(); }
        }

        function handleCustomBackFile(files) {
            if (files.length > 0 && inspectorIndex >= 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    deck[inspectorIndex].back = e.target.result;
                    deck[inspectorIndex].originalBack = e.target.result;
                    updateInspectorUI();
                };
                reader.readAsDataURL(files[0]);
            }
        }

        function handleCustomFrontFile(files) {
            if (files.length > 0 && inspectorIndex >= 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newFront = e.target.result;
                    const card = deck[inspectorIndex];
                    
                    card.originalFront = newFront;
                    card.printsUri = null;
                    
                    processImage(newFront, card.trimMm, card.bleedMm, card.hasBleed, (processed) => {
                        card.front = processed;
                        document.getElementById('inspector-front').src = processed;
                        document.getElementById('versions-btn-container').style.display = 'none';
                        
                        if (currentStep === 3) renderPreviewGrid();
                        if (currentStep === 1 && currentCardIndex === inspectorIndex) {
                             updateCanvas();
                             const editorBtn = document.getElementById('editor-actions-btn');
                             if(editorBtn) editorBtn.style.display = 'none'; 
                        }
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        }

        function revertToGlobalBack() {
            if (inspectorIndex >= 0) {
                deck[inspectorIndex].back = null; 
                updateInspectorUI();
            }
        }

        function updateInspectorUI() {
            const card = deck[inspectorIndex];
            const backImg = document.getElementById('inspector-back');
            const backStatus = document.getElementById('back-status');
            const revertBtn = document.getElementById('revert-btn');
            
            let src = null;
            let isCustom = false;

            if (card.back) {
                src = card.back;
                isCustom = true;
            } else if (globalBack.processed) {
                src = globalBack.processed;
            } else if (globalBack.original) {
                src = globalBack.original;
            }

            if (src) {
                backImg.src = src;
                backImg.classList.remove('hidden');
                const parent = backImg.parentElement;
                const placeholder = parent.querySelector('div.absolute');
                if(placeholder) placeholder.style.display = 'none'; 
            } else {
                backImg.src = '';
                backImg.classList.add('hidden');
                const parent = backImg.parentElement;
                const placeholder = parent.querySelector('div.absolute');
                if(placeholder) placeholder.style.display = 'flex';
            }

            if (isCustom) {
                backStatus.classList.remove('hidden');
                revertBtn.classList.remove('hidden');
            } else {
                backStatus.classList.add('hidden');
                revertBtn.classList.add('hidden');
            }
        }

        function updateDeckStats() {
            // Count total cards based on quantity
            const count = deck.reduce((acc, card) => acc + (card.quantity || 1), 0);
            
            let pricePerCard = 0.35;
            if (count >= 500) {
                pricePerCard = 0.26;
            } else if (count >= 145) {
                pricePerCard = 0.30;
            }
            
            const total = (count * pricePerCard).toFixed(2);
            
            document.getElementById('deck-stats').innerText = `${count} Cards • S33 Stock`;
            document.getElementById('total-price').innerText = `Total: $${total}`;
            
            // Show/hide checkout button in preview
            const checkoutBtn = document.getElementById('checkout-button-container');
            if (checkoutBtn) {
                if (count > 0 && currentStep === 3) {
                    checkoutBtn.classList.remove('hidden');
                } else {
                    checkoutBtn.classList.add('hidden');
                }
            }
        }

        // Checkout Functions
        function openCheckoutModal() {
            const modal = document.getElementById('checkout-modal');
            if (!modal) return;
            
            // Update order summary
            const count = deck.reduce((acc, card) => acc + (card.quantity || 1), 0);
            let pricePerCard = 0.35;
            if (count >= 500) {
                pricePerCard = 0.26;
            } else if (count >= 145) {
                pricePerCard = 0.30;
            }
            
            const cardsTotal = count * pricePerCard;
            const shippingCost = getShippingCost('US'); // Default to US
            
            document.getElementById('checkout-quantity').innerText = `${count} cards @ $${pricePerCard.toFixed(2)}/card`;
            document.getElementById('checkout-cards-total').innerText = `$${cardsTotal.toFixed(2)}`;
            document.getElementById('checkout-shipping').innerText = `$${shippingCost.toFixed(2)}`;
            document.getElementById('checkout-total').innerText = `$${(cardsTotal + shippingCost).toFixed(2)}`;
            
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeCheckoutModal() {
            const modal = document.getElementById('checkout-modal');
            if (modal) modal.classList.add('hidden');
        }

        function getShippingCost(country) {
            return country === 'US' ? 6.95 : 24.95;
        }

        function updateShippingCost() {
            const country = document.getElementById('checkout-country').value;
            if (!country) return;
            
            const count = deck.reduce((acc, card) => acc + (card.quantity || 1), 0);
            let pricePerCard = 0.35;
            if (count >= 500) {
                pricePerCard = 0.26;
            } else if (count >= 145) {
                pricePerCard = 0.30;
            }
            
            const cardsTotal = count * pricePerCard;
            const shippingCost = getShippingCost(country === 'US' ? 'US' : 'OTHER');
            
            document.getElementById('checkout-shipping').innerText = `$${shippingCost.toFixed(2)}`;
            document.getElementById('checkout-total').innerText = `$${(cardsTotal + shippingCost).toFixed(2)}`;
        }

        async function handleCheckout(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('checkout-submit-btn');
            const submitText = document.getElementById('checkout-submit-text');
            
            // Disable button
            submitBtn.disabled = true;
            submitText.innerText = 'Processing...';
            
            try {
                // Get form data
                const shippingAddress = {
                    email: document.getElementById('checkout-email').value,
                    name: document.getElementById('checkout-name').value,
                    line1: document.getElementById('checkout-line1').value,
                    line2: document.getElementById('checkout-line2').value,
                    city: document.getElementById('checkout-city').value,
                    state: document.getElementById('checkout-state').value,
                    postal_code: document.getElementById('checkout-postal').value,
                    country: document.getElementById('checkout-country').value
                };
                
                // Calculate quantity
                const quantity = deck.reduce((acc, card) => acc + (card.quantity || 1), 0);
                
                // Prepare card images organized properly (front/back pairs)
                const frontImages = deck.map(card => card.front || card.originalFront).filter(Boolean);
                
                // Collect back images - use card-specific back, or global back, or null
                const backImages = [];
                deck.forEach((card) => {
                    const backImg = card.back || card.originalBack || globalBack.processed || globalBack.original;
                    if (backImg) backImages.push(backImg);
                });
                
                // Prepare card data WITHOUT base64 images (we'll upload separately)
                const cardData = deck.map((card) => ({
                    quantity: card.quantity || 1,
                    trimMm: card.trimMm || 0,
                    bleedMm: card.bleedMm || 2,
                    hasBleed: card.hasBleed || false
                }));
                
                // Detect API URL
                let API_URL;
                let UPLOAD_API_URL;
                if (window.location.protocol === 'file:') {
                    API_URL = 'http://localhost:3001/api/checkout';
                    UPLOAD_API_URL = 'http://localhost:3001/api/upload-images';
                } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    const port = window.location.port || '3001';
                    API_URL = `http://localhost:${port}/api/checkout`;
                    UPLOAD_API_URL = `http://localhost:${port}/api/upload-images`;
                } else {
                    API_URL = '/api/checkout';
                    UPLOAD_API_URL = '/api/upload-images';
                }
                
                // Combine all images in order: [front1, back1, front2, back2, ...]
                // This is CRITICAL - backend expects pairs!
                const allImages = [];
                for (let i = 0; i < frontImages.length; i++) {
                    if (frontImages[i]) allImages.push(frontImages[i]);
                    if (backImages[i]) allImages.push(backImages[i]);
                }
                
                // Check total payload size with base64
                const testPayload = {
                    quantity,
                    shippingAddress,
                    cardImages: allImages,
                    cardData
                };
                const payloadSizeMB = (new Blob([JSON.stringify(testPayload)]).size / (1024 * 1024)).toFixed(2);
                console.log(`📊 Estimated payload size: ${payloadSizeMB} MB`);
                
                let uploadedImageUrls = [];
                
                // If payload is too large (>4MB), upload images in chunks first
                if (parseFloat(payloadSizeMB) > 4.0) {
                    console.log(`📤 Payload too large (${payloadSizeMB} MB), uploading images via backend first...`);
                    submitText.innerText = 'Uploading images...';
                    
                    // Generate temp order ID
                    const tempOrderId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    console.log(`📦 Total images to upload: ${allImages.length} (${frontImages.length} fronts, ${backImages.length} backs)`);
                    
                    // Upload in chunks of 5 images to stay under 4.5MB limit per request
                    // Chunk size must be even to preserve front/back pairs
                    const CHUNK_SIZE = 6; // 3 cards per chunk (6 images = 3 front + 3 back pairs)
                    const totalChunks = Math.ceil(allImages.length / CHUNK_SIZE);
                    
                    for (let i = 0; i < allImages.length; i += CHUNK_SIZE) {
                        const chunk = allImages.slice(i, i + CHUNK_SIZE);
                        const chunkNum = Math.floor(i / CHUNK_SIZE) + 1;
                        
                        submitText.innerText = `Uploading batch ${chunkNum}/${totalChunks}...`;
                        console.log(`📤 Uploading chunk ${chunkNum}/${totalChunks}: ${chunk.length} images`);
                        
                        try {
                            const uploadResponse = await fetch(UPLOAD_API_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    images: chunk,
                                    orderId: tempOrderId,
                                    shippingAddress
                                })
                            });
                            
                            if (!uploadResponse.ok) {
                                const errorText = await uploadResponse.text();
                                console.error(`❌ Upload failed for chunk ${chunkNum}:`, errorText);
                                throw new Error(`Upload failed: ${errorText}`);
                            }
                            
                            const uploadData = await uploadResponse.json();
                            if (uploadData.imageUrls && uploadData.imageUrls.length > 0) {
                                uploadedImageUrls.push(...uploadData.imageUrls);
                                console.log(`✅ Chunk ${chunkNum} uploaded: ${uploadData.imageUrls.length} URLs received`);
                            } else {
                                console.error(`⚠️ Chunk ${chunkNum} upload returned no URLs`);
                            }
                        } catch (uploadError) {
                            console.error(`❌ Error uploading chunk ${chunkNum}:`, uploadError);
                            throw new Error(`Failed to upload images: ${uploadError.message}`);
                        }
                    }
                    
                    console.log(`✅ All images uploaded successfully: ${uploadedImageUrls.length} total URLs`);
                    
                    // Map URLs back to cardData
                    // URLs are in order: [front1, back1, front2, back2, ...]
                    const finalCardData = cardData.map((card, index) => {
                        const frontUrlIndex = index * 2;
                        const backUrlIndex = index * 2 + 1;
                        
                        return {
                            ...card,
                            frontUrl: uploadedImageUrls[frontUrlIndex] || null,
                            backUrl: uploadedImageUrls[backUrlIndex] || null
                        };
                    });
                    
                    // Send checkout request with URLs only (lightweight)
                    submitText.innerText = 'Creating checkout...';
                    
                    const checkoutPayload = {
                        quantity,
                        shippingAddress,
                        cardImages: uploadedImageUrls, // URLs instead of base64
                        cardData: finalCardData
                    };
                    
                    const checkoutPayloadSize = (new Blob([JSON.stringify(checkoutPayload)]).size / (1024 * 1024)).toFixed(2);
                    console.log(`📊 Checkout payload size with URLs: ${checkoutPayloadSize} MB`);
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(checkoutPayload)
                    });
                    
                    if (!response.ok) {
                        let error;
                        try {
                            error = await response.json();
                        } catch {
                            error = { error: await response.text() };
                        }
                        throw new Error(error.error || error.message || 'Failed to create checkout session');
                    }
                    
                    const data = await response.json();
                    
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error('No checkout URL received');
                    }
                } else {
                    // Payload is small enough, send directly
                    console.log(`✅ Payload size OK (${payloadSizeMB} MB), sending directly to checkout`);
                    submitText.innerText = 'Creating checkout...';
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testPayload)
                    });
                    
                    if (!response.ok) {
                        let error;
                        try {
                            error = await response.json();
                        } catch {
                            error = { error: await response.text() };
                        }
                        throw new Error(error.error || error.message || 'Failed to create checkout session');
                    }
                    
                    const data = await response.json();
                    
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error('No checkout URL received');
                    }
                }
                
                if (!response.ok) {
                    let error;
                    try {
                        error = await response.json();
                    } catch {
                        error = { error: await response.text() };
                    }
                    throw new Error(error.error || error.message || 'Failed to create checkout session');
                }
                
                const data = await response.json();
                
                if (data.url) {
                    // Redirect to Stripe Checkout
                    window.location.href = data.url;
                } else {
                    throw new Error('No checkout URL received');
                }
                
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Checkout failed: ' + error.message);
                submitBtn.disabled = false;
                submitText.innerText = 'Proceed to Payment';
            }
        }

        function nextCard() {
            if (deck.length === 0) return;
            currentCardIndex = (currentCardIndex + 1) % deck.length;
            syncPrepControls(deck[currentCardIndex]);
            updateCanvas();
        }

        function prevCard() {
            if (deck.length === 0) return;
            currentCardIndex = (currentCardIndex - 1 + deck.length) % deck.length;
            syncPrepControls(deck[currentCardIndex]);
            updateCanvas();
        }

    </script>
</body>
</html>
